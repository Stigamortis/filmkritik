<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmkritik Analys - Sentimentanalys f칬r filmrecensioner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        /* Samma CSS som tidigare */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #0f171e;
            color: #fff;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(to right, #0f171e, #1a242f);
            padding: 20px 0;
            border-bottom: 1px solid #303a44;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: bold;
            color: #f5c518;
            margin-bottom: 15px;
        }

        .logo i {
            font-size: 32px;
        }

        .tagline {
            color: #aaa;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 40px 0;
        }

        .analysis-section {
            background-color: #1a242f;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #f5c518;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-area {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
            color: #ddd;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            background-color: #0f171e;
            border: 1px solid #303a44;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #f5c518;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #f5c518;
            color: #000;
        }

        .btn-primary:hover {
            background-color: #e0b50f;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #2c3e50;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #34495e;
        }

        .btn-example {
            background-color: #1a242f;
            color: #f5c518;
            border: 1px solid #f5c518;
        }

        .btn-example:hover {
            background-color: #f5c518;
            color: #000;
        }

        .results-section {
            background-color: #1a242f;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 24px;
            color: #f5c518;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confidence-level {
            font-size: 18px;
            color: #aaa;
        }

        .sentiment-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .sentiment-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 25px;
            border-radius: 10px;
            width: 200px;
            transition: all 0.3s;
            opacity: 0.6;
        }

        .sentiment-option.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        .sentiment-option.positive.active {
            background: linear-gradient(to bottom right, rgba(46, 204, 113, 0.2), rgba(39, 174, 96, 0.1));
            border: 2px solid #2ecc71;
        }

        .sentiment-option.negative.active {
            background: linear-gradient(to bottom right, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.1));
            border: 2px solid #e74c3c;
        }

        .sentiment-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .positive .sentiment-icon {
            color: #2ecc71;
        }

        .negative .sentiment-icon {
            color: #e74c3c;
        }

        .sentiment-label {
            font-size: 24px;
            font-weight: bold;
        }

        .sentiment-percentage {
            font-size: 36px;
            font-weight: bold;
        }

        .positive .sentiment-percentage {
            color: #2ecc71;
        }

        .negative .sentiment-percentage {
            color: #e74c3c;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 20px;
            background-color: #0f171e;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(to right, #e74c3c, #f5c518, #2ecc71);
            border-radius: 10px;
            transition: width 0.8s ease-out;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
        }

        .analysis-text {
            background-color: #0f171e;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid #f5c518;
        }

        .analysis-text h4 {
            margin-bottom: 10px;
            color: #f5c518;
        }

        .examples-section {
            background-color: #1a242f;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .example-card {
            background-color: #0f171e;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #303a44;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-card:hover {
            transform: translateY(-5px);
            border-left-color: #f5c518;
        }

        .example-text {
            font-style: italic;
            color: #ddd;
            margin-bottom: 10px;
        }

        .example-sentiment {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .example-positive {
            color: #2ecc71;
        }

        .example-negative {
            color: #e74c3c;
        }

        .model-info-panel {
            background-color: #1a242f;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #f5c518;
        }

        .model-info-panel h4 {
            color: #f5c518;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-details {
            font-family: monospace;
            background-color: #0f171e;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }

        .debug-info {
            background-color: #1a242f;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #888;
            border-left: 3px solid #f5c518;
        }

        footer {
            margin-top: 40px;
            padding: 30px 0;
            border-top: 1px solid #303a44;
            text-align: center;
            color: #aaa;
            font-size: 14px;
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .model-info {
            text-align: left;
            background-color: #1a242f;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #888;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #f5c518;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sentiment-display {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .footer-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-film"></i>
                <span>Filmkritik Analys</span>
            </div>
            <div class="tagline">
                Analysera sentiment i filmrecensioner med maskininl칛rning - Ange en engelsk mening f칬r att avg칬ra om den 칛r positiv eller negativ
            </div>
        </div>
    </header>

    <div class="container">
        <main class="main-content">
            <section class="analysis-section">
                <h2 class="section-title">
                    <i class="fas fa-comment-alt"></i>
                    Analysera filmrecension
                </h2>
                <div class="input-area">
                    <label for="review-text" class="input-label">
                        Skriv eller klistra in en engelsk filmrecension:
                    </label>
                    <textarea id="review-text" placeholder="Exempel: This movie was absolutely fantastic! The acting was superb and the plot kept me engaged from start to finish."></textarea>
                    
                    <div class="button-group">
                        <button id="analyze-btn" class="btn btn-primary">
                            <i class="fas fa-chart-bar"></i>
                            Analysera sentiment
                        </button>
                        <button id="clear-btn" class="btn btn-secondary">
                            <i class="fas fa-eraser"></i>
                            Rensa
                        </button>
                        <button id="inspect-metadata-btn" class="btn btn-example">
                            <i class="fas fa-search"></i>
                            Inspektera metadata
                        </button>
                    </div>
                    
                    <div class="loading" id="loading-indicator">
                        <div class="spinner"></div>
                        <p>Analyserar texten med AI-modellen...</p>
                    </div>
                </div>
                
                <div class="model-info-panel">
                    <h4><i class="fas fa-microchip"></i> Modellinformation</h4>
                    <div class="model-details">
                        <div><strong>Kr칛vd input shape:</strong> [batch_size, 256]</div>
                        <div><strong>Textl칛ngd:</strong> Exakt 256 tokens</div>
                        <div id="actual-input-shape">Laddar modellinformation...</div>
                        <div id="vocab-info">Laddar vokabul칛rinformation...</div>
                    </div>
                    <div class="debug-info" id="debug-info">
                        Status: V칛ntar p친 att modellen ska laddas...
                    </div>
                </div>
            </section>

            <section class="results-section">
                <div class="results-header">
                    <h2 class="results-title">
                        <i class="fas fa-poll"></i>
                        Analysresultat
                    </h2>
                    <div class="confidence-level" id="confidence-level">
                        Sannolikhet: <span id="confidence-value">-</span>
                    </div>
                </div>
                
                <div class="sentiment-display">
                    <div class="sentiment-option negative" id="negative-sentiment">
                        <div class="sentiment-icon">
                            <i class="fas fa-frown"></i>
                        </div>
                        <div class="sentiment-label">Negativ</div>
                        <div class="sentiment-percentage" id="negative-percentage">0%</div>
                    </div>
                    
                    <div class="sentiment-option positive" id="positive-sentiment">
                        <div class="sentiment-icon">
                            <i class="fas fa-smile"></i>
                        </div>
                        <div class="sentiment-label">Positiv</div>
                        <div class="sentiment-percentage" id="positive-percentage">0%</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-labels">
                        <span>Negativ (0%)</span>
                        <span>Positiv (100%)</span>
                    </div>
                </div>
                
                <div class="analysis-text">
                    <h4>Analys av din text:</h4>
                    <p id="analysis-output">Ingen analys utf칬rd 칛n. Skriv en filmrecension och klicka p친 "Analysera sentiment" f칬r att b칬rja.</p>
                    <div id="token-info" style="margin-top: 10px; font-size: 14px; color: #aaa;"></div>
                </div>
            </section>

            <section class="examples-section">
                <h2 class="section-title">
                    <i class="fas fa-lightbulb"></i>
                    Exempel p친 recensioner att testa
                </h2>
                <p>Klicka p친 ett exempel f칬r att analysera det direkt:</p>
                
                <div class="examples-grid">
                    <div class="example-card" data-example="This movie was absolutely fantastic! The acting was superb and the plot kept me engaged from start to finish. The cinematography was breathtaking and the soundtrack perfectly complemented every scene.">
                        <div class="example-text">"This movie was absolutely fantastic! The acting was superb..."</div>
                        <div class="example-sentiment example-positive">
                            <i class="fas fa-smile"></i>
                            F칬rv칛ntat: Positiv
                        </div>
                    </div>
                    
                    <div class="example-card" data-example="A complete waste of time. Poor acting, terrible dialogue, and a predictable plot that offers nothing new. The characters were one-dimensional and the pacing was painfully slow.">
                        <div class="example-text">"A complete waste of time. Poor acting, terrible dialogue..."</div>
                        <div class="example-sentiment example-negative">
                            <i class="fas fa-frown"></i>
                            F칬rv칛ntat: Negativ
                        </div>
                    </div>
                    
                    <div class="example-card" data-example="While the cinematography was stunning, the characters felt underdeveloped and the story dragged in the middle section. The director had an interesting vision but the execution fell flat.">
                        <div class="example-text">"While the cinematography was stunning, the characters felt underdeveloped..."</div>
                        <div class="example-sentiment example-negative">
                            <i class="fas fa-frown"></i>
                            F칬rv칛ntat: Negativ
                        </div>
                    </div>
                    
                    <div class="example-card" data-example="An instant classic! The director's vision shines through every frame, with brilliant performances from the entire cast. The screenplay is masterfully written, balancing humor, drama, and suspense perfectly.">
                        <div class="example-text">"An instant classic! The director's vision shines through every frame..."</div>
                        <div class="example-sentiment example-positive">
                            <i class="fas fa-smile"></i>
                            F칬rv칛ntat: Positiv
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer>
            <p>Filmkritik Analys - Sentimentanalys f칬r filmrecensioner med TensorFlow.js</p>
            <div class="footer-info">
                <div class="model-info">
                    <p><strong>Modellinformation:</strong> AI-modellen f칬r sentimentanalys laddas fr친n mappen <code>tfjs_model</code>.</p>
                    <p><strong>Input dimension:</strong> Modellen kr칛ver exakt <code>[batch_size, 256]</code> som input.</p>
                </div>
                <div>
                    <p>Denna applikation anv칛nder en f칬rtr칛nad TensorFlow.js-modell f칬r textklassificering.</p>
                    <p>Modellen finns i undermappen <code>tfjs_model</code> tillsammans med <code>metadata.json</code>.</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // DOM Elements
        const reviewTextarea = document.getElementById('review-text');
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const inspectMetadataBtn = document.getElementById('inspect-metadata-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const positivePercentage = document.getElementById('positive-percentage');
        const negativePercentage = document.getElementById('negative-percentage');
        const positiveSentiment = document.getElementById('positive-sentiment');
        const negativeSentiment = document.getElementById('negative-sentiment');
        const progressFill = document.getElementById('progress-fill');
        const analysisOutput = document.getElementById('analysis-output');
        const confidenceValue = document.getElementById('confidence-value');
        const exampleCards = document.querySelectorAll('.example-card');
        const debugInfo = document.getElementById('debug-info');
        const tokenInfo = document.getElementById('token-info');
        const actualInputShape = document.getElementById('actual-input-shape');
        const vocabInfo = document.getElementById('vocab-info');
        
        // TensorFlow.js model
        let model = null;
        let metadata = null;
        const REQUIRED_SEQUENCE_LENGTH = 256;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Laddar TensorFlow.js modell...');
            debugInfo.textContent = 'Laddar modell...';
            
            try {
                analyzeBtn.disabled = true;
                inspectMetadataBtn.disabled = true;
                analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Laddar modell...';
                
                // Load metadata first
                const response = await fetch('./tfjs_model/metadata.json');
                metadata = await response.json();
                console.log('Metadata laddad:', metadata);
                
                // Load model
                model = await tf.loadLayersModel('./tfjs_model/model.json');
                console.log('Modell laddad:', model);
                
                // Display model info
                if (model.inputs && model.inputs[0]) {
                    const inputShape = model.inputs[0].shape;
                    actualInputShape.innerHTML = `<strong>Inl칛st input shape:</strong> [${inputShape.join(', ')}]`;
                    
                    if (inputShape[1] !== REQUIRED_SEQUENCE_LENGTH) {
                        console.warn(`Modell f칬rv칛ntar ${inputShape[1]} tokens, vi anv칛nder ${REQUIRED_SEQUENCE_LENGTH}`);
                        debugInfo.textContent = `Varning: Modell f칬rv칛ntar ${inputShape[1]} tokens, anv칛nder ${REQUIRED_SEQUENCE_LENGTH}`;
                    }
                }
                
                // Display vocab info
                const vocabSize = metadata.vocabulary_size || 'Ok칛nt';
                const wordIndexSize = metadata.word_index ? Object.keys(metadata.word_index).length : 'Ok칛nt';
                vocabInfo.innerHTML = `<strong>Vokabul칛r:</strong> ${vocabSize} ord, ${wordIndexSize} indexerade`;
                
                // Test with a known sample word
                if (metadata.word_index) {
                    const testWords = ['good', 'bad', 'movie', 'great', 'terrible'];
                    const foundWords = testWords.filter(word => metadata.word_index[word]);
                    console.log(`Hittade ${foundWords.length} av ${testWords.length} testord i metadata`);
                }
                
                analyzeBtn.disabled = false;
                inspectMetadataBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Analysera sentiment';
                analysisOutput.textContent = 'Modell laddad. Testa med en filmrecension!';
                debugInfo.textContent = `Modell laddad. Vokabul칛r: ${vocabSize} ord.`;
                
            } catch (error) {
                console.error('Fel vid laddning:', error);
                debugInfo.textContent = 'Fel: ' + error.message;
                analysisOutput.textContent = 'Kunde inte ladda modellen. Fel: ' + error.message;
                analyzeBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Modell kunde inte laddas';
            }
            
            setupEventListeners();
        });
        
        function setupEventListeners() {
            analyzeBtn.addEventListener('click', analyzeText);
            clearBtn.addEventListener('click', resetAll);
            inspectMetadataBtn.addEventListener('click', inspectMetadata);
            
            exampleCards.forEach(card => {
                card.addEventListener('click', function() {
                    const exampleText = this.getAttribute('data-example');
                    reviewTextarea.value = exampleText;
                    analyzeText();
                });
            });
            
            reviewTextarea.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    analyzeText();
                }
            });
        }
        
        function inspectMetadata() {
            if (!metadata) {
                alert('Metadata inte laddad 칛n.');
                return;
            }
            
            let info = 'Metadata Information:\n\n';
            info += `Vocabulary size: ${metadata.vocabulary_size || 'Saknas'}\n`;
            info += `Max sequence length: ${metadata.max_len || 'Saknas'}\n`;
            info += `Word index keys: ${metadata.word_index ? Object.keys(metadata.word_index).length : 0}\n\n`;
            
            // Show some example word mappings
            if (metadata.word_index) {
                const sampleWords = ['the', 'movie', 'good', 'bad', 'great', 'terrible', 'love', 'hate'];
                info += 'Exempel p친 ord-index:\n';
                sampleWords.forEach(word => {
                    if (metadata.word_index[word]) {
                        info += `${word}: ${metadata.word_index[word]}\n`;
                    }
                });
            }
            
            console.log('Metadata info:', info);
            debugInfo.textContent = `Metadata: ${metadata.vocabulary_size || '?'} ord, ${metadata.word_index ? Object.keys(metadata.word_index).length : '?'} index`;
            alert(info);
        }
        
        async function analyzeText() {
            const text = reviewTextarea.value.trim();
            
            if (!text) {
                alert('V칛nligen ange en text att analysera.');
                return;
            }
            
            if (!model || !metadata) {
                alert('Modellen eller metadata inte laddad. Anv칛nder fallback-analys.');
                const positiveProb = fallbackSentimentAnalysis(text);
                updateResults(positiveProb, 1 - positiveProb, text);
                return;
            }
            
            loadingIndicator.style.display = 'block';
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyserar...';
            
            try {
                // Create sequence using metadata
                const sequence = createSequenceFromMetadata(text);
                
                console.log('Skapar input tensor med shape:', sequence.shape);
                debugInfo.textContent = `Input shape: [${sequence.shape.join(', ')}]`;
                
                // Make prediction
                const prediction = model.predict(sequence);
                const score = await prediction.data();
                const positiveProb = score[0];
                const negativeProb = 1 - positiveProb;
                
                console.log('Prediktion:', positiveProb);
                
                updateResults(positiveProb, negativeProb, text);
                debugInfo.textContent += ` | Resultat: ${positiveProb.toFixed(4)}`;
                
                // Clean up
                sequence.dispose();
                prediction.dispose();
                
            } catch (error) {
                console.error('Analysfel:', error);
                debugInfo.textContent = 'Fel: ' + error.message;
                
                // Fallback
                const positiveProb = fallbackSentimentAnalysis(text);
                updateResults(positiveProb, 1 - positiveProb, text);
            } finally {
                loadingIndicator.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Analysera sentiment';
            }
        }
        
        function createSequenceFromMetadata(text) {
            // Get tokenization settings from metadata
            const wordIndex = metadata.word_index || {};
            const vocabSize = metadata.vocabulary_size || 10000;
            const maxLen = metadata.max_len || REQUIRED_SEQUENCE_LENGTH;
            
            // Clean and tokenize text
            const cleanText = text.toLowerCase()
                .replace(/[^\w\s']/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            const tokens = cleanText.split(/\s+/);
            
            // Debug tokenization
            console.log(`Original: "${text.substring(0, 50)}..."`);
            console.log(`Clean: "${cleanText.substring(0, 50)}..."`);
            console.log(`Tokens: ${tokens.length} tokens`);
            console.log('Sample tokens:', tokens.slice(0, 10));
            
            // Convert tokens to indices
            const sequence = [];
            const unknownWords = [];
            
            for (const token of tokens) {
                if (sequence.length >= maxLen) break;
                
                let index = wordIndex[token];
                
                if (!index) {
                    // Check for common variations
                    const variations = [
                        token,
                        token.replace(/'s$/, ''),
                        token.replace(/s$/, ''),
                        token.replace(/ing$/, ''),
                        token.replace(/ed$/, '')
                    ];
                    
                    for (const variation of variations) {
                        if (wordIndex[variation]) {
                            index = wordIndex[variation];
                            break;
                        }
                    }
                    
                    if (!index) {
                        // Unknown word - use UNK token or hash
                        index = wordIndex['<UNK>'] || wordIndex['unk'] || 1;
                        unknownWords.push(token);
                    }
                }
                
                sequence.push(index);
            }
            
            // Log unknown words
            if (unknownWords.length > 0) {
                console.log(`Ok칛nda ord (${unknownWords.length}):`, unknownWords.slice(0, 10));
                tokenInfo.textContent = `${unknownWords.length} ok칛nda ord hittades.`;
            } else {
                tokenInfo.textContent = `Alla ${tokens.length} tokens hittades i vokabul칛ren.`;
            }
            
            // Pad or truncate to exact length
            const finalSequence = [];
            
            if (sequence.length > maxLen) {
                // Truncate
                finalSequence.push(...sequence.slice(0, maxLen));
                console.log(`Trunkerade fr친n ${sequence.length} till ${maxLen} tokens`);
            } else if (sequence.length < maxLen) {
                // Pad with zeros
                finalSequence.push(...sequence);
                const padding = new Array(maxLen - sequence.length).fill(0);
                finalSequence.push(...padding);
                console.log(`Paddade fr친n ${sequence.length} till ${maxLen} tokens`);
            } else {
                finalSequence.push(...sequence);
            }
            
            // Verify length
            if (finalSequence.length !== maxLen) {
                throw new Error(`Felaktig sekvensl칛ngd: ${finalSequence.length}, f칬rv칛ntade ${maxLen}`);
            }
            
            console.log(`Skapar tensor med ${finalSequence.length} v칛rden`);
            console.log('F칬rsta 10 v칛rden:', finalSequence.slice(0, 10));
            
            return tf.tensor2d([finalSequence], [1, maxLen]);
        }
        
        function updateResults(positiveProb, negativeProb, originalText) {
            // Format probabilities
            const positivePercent = Math.round(positiveProb * 100);
            const negativePercent = Math.round(negativeProb * 100);
            
            // Update displays
            positivePercentage.textContent = `${positivePercent}%`;
            negativePercentage.textContent = `${negativePercent}%`;
            
            // Update confidence
            const confidence = Math.max(positiveProb, negativeProb);
            confidenceValue.textContent = `${Math.round(confidence * 100)}%`;
            
            // Update progress bar
            progressFill.style.width = `${positivePercent}%`;
            
            // Update sentiment display
            if (positiveProb > negativeProb) {
                positiveSentiment.classList.add('active');
                negativeSentiment.classList.remove('active');
            } else {
                negativeSentiment.classList.add('active');
                positiveSentiment.classList.remove('active');
            }
            
            // Create analysis text
            const sentiment = positiveProb > negativeProb ? 'POSITIV' : 'NEGATIV';
            const sentimentColor = positiveProb > negativeProb ? '#2ecc71' : '#e74c3c';
            const sentimentIcon = positiveProb > negativeProb ? '游땕' : '游';
            
            let confidenceLevel = '';
            if (confidence > 0.9) confidenceLevel = 'mycket h칬g';
            else if (confidence > 0.7) confidenceLevel = 'h칬g';
            else if (confidence > 0.6) confidenceLevel = 'm친ttlig';
            else confidenceLevel = 'l친g';
            
            // Display result
            const displayText = originalText.length > 100 
                ? originalText.substring(0, 100) + '...' 
                : originalText;
            
            analysisOutput.innerHTML = `
                <span style="color: ${sentimentColor}; font-weight: bold;">
                    ${sentimentIcon} ${sentiment} SENTIMENT
                </span>
                <br><br>
                <strong>Sannolikhet:</strong> ${positivePercent}% positiv, ${negativePercent}% negativ
                <br>
                <strong>Konfidens:</strong> ${confidenceLevel} (${Math.round(confidence * 100)}%)
                <br><br>
                <strong>Text analyserad:</strong> "${displayText}"
            `;
            
            // Update progress labels
            document.querySelector('.progress-labels').innerHTML = `
                <span>Negativ (${negativePercent}%)</span>
                <span>Positiv (${positivePercent}%)</span>
            `;
        }
        
        function resetAll() {
            reviewTextarea.value = '';
            positivePercentage.textContent = '0%';
            negativePercentage.textContent = '0%';
            confidenceValue.textContent = '-';
            progressFill.style.width = '50%';
            positiveSentiment.classList.remove('active');
            negativeSentiment.classList.remove('active');
            analysisOutput.textContent = 'Ingen analys utf칬rd 칛n. Skriv en filmrecension och klicka p친 "Analysera sentiment" f칬r att b칬rja.';
            tokenInfo.textContent = '';
            document.querySelector('.progress-labels').innerHTML = `
                <span>Negativ (0%)</span>
                <span>Positiv (100%)</span>
            `;
            debugInfo.textContent = 'Allt rensat. Klar f칬r ny analys.';
        }
        
        function fallbackSentimentAnalysis(text) {
            // Enhanced fallback analysis
            const positivePatterns = [
                /\b(great|excellent|amazing|fantastic|wonderful|best|love|liked|enjoyed|awesome|brilliant|superb|outstanding)\b/gi,
                /\b(good|nice|pleasant|enjoyable|positive|recommend)\b/gi,
                /\b(masterpiece|perfect|beautiful|engaging|captivating|emotional|powerful)\b/gi,
                /!\s*$/,
                /\b(one of the best|highly recommend|must see|worth watching)\b/gi
            ];
            
            const negativePatterns = [
                /\b(bad|terrible|awful|worst|hate|dislike|poor|boring|disappointing)\b/gi,
                /\b(waste|horrible|stupid|ridiculous|predictable|slow|dull|unoriginal)\b/gi,
                /\b(forgettable|confusing|messy|disjointed|avoid|skip|pointless)\b/gi,
                /\b(not good|not great|disappointingly|waste of time)\b/gi
            ];
            
            const lowerText = text.toLowerCase();
            let positiveScore = 0;
            let negativeScore = 0;
            
            // Count positive patterns
            positivePatterns.forEach(pattern => {
                const matches = lowerText.match(pattern);
                if (matches) positiveScore += matches.length * 2;
            });
            
            // Count negative patterns
            negativePatterns.forEach(pattern => {
                const matches = lowerText.match(pattern);
                if (matches) negativeScore += matches.length * 2;
            });
            
            // Adjust for negations
            if (lowerText.includes('not bad') || lowerText.includes('not terrible')) {
                positiveScore += 3;
                negativeScore -= 2;
            }
            
            if (lowerText.includes('not good') || lowerText.includes('not great')) {
                negativeScore += 3;
                positiveScore -= 2;
            }
            
            // Adjust for intensifiers
            if (lowerText.includes('really ') || lowerText.includes('very ') || lowerText.includes('absolutely ')) {
                positiveScore += 1;
                negativeScore += 1;
            }
            
            // Calculate probability
            const total = positiveScore + negativeScore;
            let positiveProb;
            
            if (total === 0) {
                positiveProb = 0.5; // Neutral
            } else {
                positiveProb = positiveScore / total;
            }
            
            // Clamp between 0.1 and 0.9
            positiveProb = Math.max(0.1, Math.min(0.9, positiveProb));
            
            console.log(`Fallback analys: positiveScore=${positiveScore}, negativeScore=${negativeScore}, prob=${positiveProb}`);
            
            return positiveProb;
        }
    </script>
</body>
</html>
